<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Sysimages · PackageCompiler</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">PackageCompiler</a></span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li><span class="tocitem">Manual</span><ul><li class="is-active"><a class="tocitem" href="sysimages.html">Sysimages</a><ul class="internal"><li><a class="tocitem" href="#What-is-a-sysimage"><span>What is a sysimage</span></a></li><li><a class="tocitem" href="#Creating-a-sysimage-using-PackageCompiler"><span>Creating a sysimage using PackageCompiler</span></a></li></ul></li><li><a class="tocitem" href="apps.html">Apps</a></li><li><a class="tocitem" href="libs.html">Libraries</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="examples/ohmyrepl.html">Creating a sysimage with OhMyREPL</a></li><li><a class="tocitem" href="examples/plots.html">Creating a sysimage for fast plotting with Plots.jl</a></li></ul></li><li><a class="tocitem" href="refs.html">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href="sysimages.html">Sysimages</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="sysimages.html">Sysimages</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaLang/PackageCompiler.jl/blob/master/docs/src/sysimages.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="sysimages"><a class="docs-heading-anchor" href="#sysimages">Sysimages</a><a id="sysimages-1"></a><a class="docs-heading-anchor-permalink" href="#sysimages" title="Permalink"></a></h1><h2 id="What-is-a-sysimage"><a class="docs-heading-anchor" href="#What-is-a-sysimage">What is a sysimage</a><a id="What-is-a-sysimage-1"></a><a class="docs-heading-anchor-permalink" href="#What-is-a-sysimage" title="Permalink"></a></h2><p>A sysimage is a file that, in a loose sense, contains a Julia session serialized to a file. A &quot;Julia session&quot; includes things like loaded packages, global variables, inferred and compiled code, etc. By starting Julia with a sysimage, the stored Julia session is deserialized and loaded. The idea behind the sysimage is that this deserialization is faster than having to reload packages and recompile code from scratch.</p><p>Julia ships with a sysimage that is used by default when Julia is started. That sysimage contains the Julia compiler itself, the standard libraries, and also compiled code that has been put there to reduce the time required to do common operations, like working in the REPL.</p><p>Sometimes it is desirable to create a custom sysimage with custom precompiled code. This is the case if one has some dependencies that take a significant time to load or where the compilation time for the first call is uncomfortably long. This section of the documentation is intended to document how to use PackageCompiler to create such sysimages.</p><h3 id="Drawbacks-to-custom-sysimages"><a class="docs-heading-anchor" href="#Drawbacks-to-custom-sysimages">Drawbacks to custom sysimages</a><a id="Drawbacks-to-custom-sysimages-1"></a><a class="docs-heading-anchor-permalink" href="#Drawbacks-to-custom-sysimages" title="Permalink"></a></h3><p>It should be clearly stated that there are some drawbacks to using a custom sysimage, thereby sidestepping the standard Julia package precompilation system. The biggest drawback is that packages that are compiled into a sysimage (including their dependencies!) are &quot;locked&quot; to the version they were at when the sysimage was created. This means that no matter what package version you have installed in your current project, the one in the sysimage will take precedence. This can lead to bugs where you start with a project that needs a specific version of a package, but you have another one compiled into the sysimage.</p><p>Putting packages in the sysimage is therefore only recommended if the load time of those packages is a significant problem and when these packages are not frequently updated. In addition, compiling &quot;workflow packages&quot; like Revise.jl and OhMyREPL.jl into a sysimage might make sense.</p><h2 id="Creating-a-sysimage-using-PackageCompiler"><a class="docs-heading-anchor" href="#Creating-a-sysimage-using-PackageCompiler">Creating a sysimage using PackageCompiler</a><a id="Creating-a-sysimage-using-PackageCompiler-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-a-sysimage-using-PackageCompiler" title="Permalink"></a></h2><p>PackageCompiler provides the function <a href="refs.html#PackageCompiler.create_sysimage"><code>create_sysimage</code></a> to create a sysimage. It takes as the first argument a package or a list of packages that should be embedded in the resulting sysimage. By default, the given packages are loaded from the active project but a specific project can be specified by giving a path to it with the <code>project</code> keyword. The location of the resulting sysimage is given by the <code>sysimage_path</code> keyword. After the sysimage is created, giving the command flag <code>-Jpath/to/sysimage</code> (or <code>--sysimage=path/to/sysimage</code>) will start Julia with the given sysimage.</p><p>Below is an example of a new sysimage, from a separate project, being created with the package Example.jl in it. Using <code>Base.loaded_modules</code> it can be seen that the package is loaded without having to explicitly <code>import</code> it.</p><pre><code class="nohighlight hljs">~
❯mkdir NewSysImageEnv

~
❯ cd NewSysImageEnv

~/NewSysImageEnv
❯ julia -q

julia&gt; using PackageCompiler

(1.7) pkg&gt; activate .
Activating new environment at `~/NewSysImageEnv/Project.toml`

(NewSysImageEnv) pkg&gt; add Example
  Updating registry at `~/.julia/registries/General`
  Updating git-repo `https://github.com/JuliaRegistries/General.git`
 Resolving package versions...
  Updating `~/NewSysImageEnv/Project.toml`
  [7876af07] + Example v0.5.3
  Updating `~/NewSysImageEnv/Manifest.toml`
  [7876af07] + Example v0.5.3

julia&gt; create_sysimage([&quot;Example&quot;]; sysimage_path=&quot;ExampleSysimage.so&quot;)
[ Info: PackageCompiler: creating system image object file, this might take a while...

julia&gt; exit()

~/NewSysImageEnv
❯ ls
ExampleSysimage.so  Manifest.toml  Project.toml

~/NewSysImageEnv
❯ julia -q -JExampleSysimage.so

julia&gt; Base.loaded_modules
Dict{Base.PkgId,Module} with 34 entries:
...
  Example [7876af07-990d-54b4-ab0e-23690620f79a] =&gt; Example
...</code></pre><p>Note that sysimages are by default created &quot;incrementally&quot; in the sense that they add to the sysimage of the process running PackageCompiler. It is possible to create a sysimage non-incrementally by passing the <code>incremental=false</code> keyword. This will create a new system image from scratch. However, it will lose the special precompilation that the Julia bundled sysimage provides which is what makes the REPL and package manager not require compilation after a Julia restart. It is therefore unlikely that <code>incremental=false</code> is of much use unless in special cases for sysimage creation (for apps it is a different story though).</p><p>As an alternative consider using another mechanism to pass the <code>-J</code> flag to Julia as above. These include creating a desktop shortcut or a shell alias, <code>$ alias julia=&#39;julia -J/path/to/sysimage.so&#39;</code>, that includes the option.</p><h3 id="tracing"><a class="docs-heading-anchor" href="#tracing">Compilation of functions</a><a id="tracing-1"></a><a class="docs-heading-anchor-permalink" href="#tracing" title="Permalink"></a></h3><p>The step where we included Example.jl in the sysimage meant that loading Example.jl is now pretty much instant (the package is already loaded when Julia starts). However, functions inside Example.jl still need to be compiled when executed for the first time. One way we can see this is by using the <code>--trace-compile=stderr</code> flag which outputs a &quot;precompile statement&quot; every time Julia compiles a function. Running the <code>hello</code> function inside Example.jl we can see that it needs to be compiled (it shows the function <code>Example.hello</code> was compiled for the input type <code>String</code>.</p><pre><code class="nohighlight hljs">~/NewSysImageEnv
❯ julia -JExampleSysimage.so --trace-compile=stderr -e &#39;import Example; Example.hello(&quot;friend&quot;)&#39;
precompile(Tuple{typeof(Example.hello), String})</code></pre><p>To remedy this, we can give a &quot;precompile script&quot; to <code>create_sysimage</code> which causes functions executed in that script to be baked into the sysimage. As an example, the script below simply calls the <code>hello</code> function in <code>Example</code>:</p><pre><code class="nohighlight hljs">~/NewSysImageEnv
❯ cat precompile_example.jl
using Example
Example.hello(&quot;friend&quot;)</code></pre><p>We now create a new system image called <code>ExampleSysimagePrecompile.so</code>, where the <code>precompile_execution_file</code> keyword argument has been given, pointing to the file shown just above:</p><pre><code class="language-julia-repl hljs">~/NewSysImageEnv
❯ julia -q

julia&gt; using PackageCompiler

(1.7) pkg&gt; activate .
Activating environment at `~/NewSysImageEnv/Project.toml`

julia&gt; PackageCompiler.create_sysimage([&quot;Example&quot;]; sysimage_path=&quot;ExampleSysimagePrecompile.so&quot;,
                                       precompile_execution_file=&quot;precompile_example.jl&quot;)

[ Info: PackageCompiler: creating system image object file, this might take a while...

julia&gt; exit()</code></pre><p>Using the just created system image, we can see that the <code>hello</code> function no longer needs to get compiled:</p><pre><code class="nohighlight hljs">~/NewSysImageEnv
❯ julia -JExampleSysimagePrecompile.so --trace-compile=stderr -e &#39;import Example; Example.hello(&quot;friend&quot;)&#39;

~/NewSysImageEnv
❯</code></pre><h4 id="Using-a-manually-generated-list-of-precompile-statements"><a class="docs-heading-anchor" href="#Using-a-manually-generated-list-of-precompile-statements">Using a manually generated list of precompile statements</a><a id="Using-a-manually-generated-list-of-precompile-statements-1"></a><a class="docs-heading-anchor-permalink" href="#Using-a-manually-generated-list-of-precompile-statements" title="Permalink"></a></h4><p>Starting Julia with <code>--trace-compile=file.jl</code> will emit precompilation statements to <code>file.jl</code> for the duration of the started Julia process. This can be useful in cases where it is difficult to give a script that executes the code (like with interactive use). A file with a list of such precompile statements can be used when creating a sysimage by passing the keyword argument <code>precompile_statements_file</code>. See the <a href="examples/ohmyrepl.html#manual-omr">OhMyREPL.jl example</a> in the docs for more details on how to use <code>--trace-compile</code> with PackageCompiler.</p><p>It is also possible to use <a href="https://timholy.github.io/SnoopCompile.jl/stable/snoopi/#auto-1">SnoopCompile.jl</a> to create files with precompilation statements.</p><h4 id="Using-a-package&#39;s-test-suite-to-generate-precompile-statements"><a class="docs-heading-anchor" href="#Using-a-package&#39;s-test-suite-to-generate-precompile-statements">Using a package&#39;s test suite to generate precompile statements</a><a id="Using-a-package&#39;s-test-suite-to-generate-precompile-statements-1"></a><a class="docs-heading-anchor-permalink" href="#Using-a-package&#39;s-test-suite-to-generate-precompile-statements" title="Permalink"></a></h4><p>It is also possible to use a package&#39;s test suite to generate a list of precompile statements by including the content:</p><pre><code class="language-julia hljs">import Example
include(joinpath(pkgdir(Example), &quot;test&quot;, &quot;runtests.jl&quot;))</code></pre><p>in the precompile file. Note that you need to have any test dependencies installed in your current project.</p><h4 id="Advanced-options-to-create_sysimage"><a class="docs-heading-anchor" href="#Advanced-options-to-create_sysimage">Advanced options to <code>create_sysimage</code></a><a id="Advanced-options-to-create_sysimage-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-options-to-create_sysimage" title="Permalink"></a></h4><ul><li>When creating a sysimage incrementally, you can use a different sysimage as the &quot;base sysimage&quot; by passing the <code>base_sysimage</code> keyword argument.</li><li>The &quot;cpu target&quot; can be specified with the <code>cpu_target</code> keyword. For more information about the syntax of this option, see the <a href="https://docs.julialang.org/en/v1/devdocs/sysimg/#Specifying-multiple-system-image-targets">Julia manual</a>.</li><li>If you need to run some code in the process creating the sysimage, the <code>script</code> argument that points to a file can be passed.</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="index.html">« Home</a><a class="docs-footer-nextpage" href="apps.html">Apps »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.6 on <span class="colophon-date" title="Sunday 14 November 2021 22:23">Sunday 14 November 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
